{% extends 'base.html' %}
{% block title %}Sale {{ sale.sale_number }} - {{ brand.name|default:'Fashion Express' }}{% endblock %}
{% block content %}
<div class="content-header d-flex justify-content-between align-items-center">
  <h1>Sale {{ sale.sale_number }}</h1>
  <div>
    {% if sale.status == 'draft' %}
      {% if user.is_superuser or perms.core.finalize_sale %}
        <a href="{% url 'sale_finalize' sale.pk %}" class="btn btn-success" onclick="return confirm('Finalize this sale? This will decrease inventory.');">
          <i class="fas fa-check"></i> Finalize
        </a>
      {% endif %}
      
    {% endif %}
    {% if user.is_superuser or perms.core.view_sale %}
      <a href="{% url 'sale_invoice' sale.pk %}" target="_blank" class="btn btn-outline-primary">
        <i class="fas fa-print"></i> Print Invoice
      </a>
    {% endif %}
    <a href="{% if request.GET.return_to %}{{ request.GET.return_to }}{% else %}{% url 'sale_list' %}{% endif %}" class="btn btn-outline-secondary"><i class="fas fa-arrow-left"></i> Back</a>
  </div>
</div>

<div class="row">
  <div class="col-lg-6">
    <div class="card">
      <div class="card-header">Overview</div>
      <div class="card-body">
        <p><strong>Customer:</strong> {{ sale.customer.name }}</p>
        <p><strong>Status:</strong> {{ sale.status|title }}</p>
        <p><strong>Total:</strong> ${{ sale.total_amount }}</p>
        <p><strong>Paid:</strong> ${{ sale.total_paid }} &nbsp; <strong>Due:</strong> ${{ sale.balance_due }}</p>
        {% if sale.finalized_at %}
          <p><strong>Finalized:</strong> {{ sale.finalized_at }} by {{ sale.finalized_by }}</p>
        {% endif %}
      </div>
    </div>
    <div class="card mt-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Payments</span>
        {% if sale.status != 'cancelled' %}
          {% if user.is_superuser or perms.core.add_salepayment %}
            <button class="btn btn-sm btn-primary" data-bs-toggle="collapse" data-bs-target="#addPaymentCollapse">
              <i class="fas fa-plus"></i> Add Payment
            </button>
          {% endif %}
        {% endif %}
        {% if user.is_superuser or perms.core.view_salepayment %}
          <a class="btn btn-sm btn-outline-secondary" href="{% url 'sale_payments_export' sale.pk %}">
            <i class="fas fa-file-csv"></i> Export CSV
          </a>
        {% endif %}
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>Receipt</th>
                <th>Date</th>
                <th>Method</th>
                <th class="text-end">Amount</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for p in payments %}
              <tr>
                <td>{{ p.receipt_number }}</td>
                <td>{{ p.payment_date }}</td>
                <td>{{ p.get_method_display }}</td>
                <td class="text-end">${{ p.amount }}</td>
                <td class="text-end">
                  {% if user.is_superuser or perms.core.view_salepayment %}
                    <a class="btn btn-sm btn-outline-secondary" href="{% url 'sale_payment_receipt' sale.pk p.pk %}" target="_blank">
                      <i class="fas fa-print"></i> Receipt
                    </a>
                  {% endif %}
                </td>
              </tr>
              {% empty %}
              <tr><td colspan="5" class="text-center">No payments recorded.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% if add_payment_form %}
        <div class="collapse mt-3" id="addPaymentCollapse">
          <form method="post" action="{% url 'sale_add_payment' sale.pk %}">
            {% csrf_token %}
            <div class="row g-2">
              <div class="col-md-4">{{ add_payment_form.amount.label_tag }} {{ add_payment_form.amount }}</div>
              <div class="col-md-4">{{ add_payment_form.payment_date.label_tag }} {{ add_payment_form.payment_date }}</div>
              <div class="col-md-4">{{ add_payment_form.method.label_tag }} {{ add_payment_form.method }}</div>
            </div>
            <div class="mt-2">
              <button type="submit" class="btn btn-primary btn-sm"><i class="fas fa-check"></i> Save Payment</button>
            </div>
          </form>
        </div>
          {% elif sale.status == 'quote' %}
            <div class="alert alert-info mt-3">This is a quotation. Convert to an invoice to accept payments and affect stock.</div>
            {% if perms.core.change_sale %}
              <a href="{% url 'sale_convert_to_invoice' sale.pk %}" class="btn btn-outline-primary"><i class="fas fa-exchange-alt"></i> Convert to Invoice</a>
            {% endif %}
          {% endif %}
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="card">
      <div class="card-header">
        <span>Items</span>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>Type</th>
                <th>Name</th>
                <th class="text-end">Qty</th>
                <th class="text-end">Unit Price</th>
                <th class="text-end">Total</th>
              </tr>
            </thead>
            <tbody>
              {% for item in items %}
              <tr>
                <td>{{ item.get_item_type_display }}</td>
                <td>
                  {% if item.item_type == 'inventory' and item.inventory_item %}
                    {{ item.inventory_item.part_name }} ({{ item.inventory_item.part_code }})
                  {% else %}
                    {{ item.description }}
                  {% endif %}
                </td>
                <td class="text-end">{{ item.quantity }}</td>
                <td class="text-end">${{ item.unit_price }}</td>
                <td class="text-end">${{ item.line_total }}</td>
              </tr>
              {% empty %}
              <tr><td colspan="5" class="text-center">No items yet.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
