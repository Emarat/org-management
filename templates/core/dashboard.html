{% extends 'base.html' %}

{% block title %}Dashboard - Organization Management{% endblock %}

{% block content %}
{# Minimal dashboard for users with only bill permissions #}
{% if not perms.core.view_customers_menu and not perms.core.view_inventory_menu and not perms.core.view_expenses_menu and not perms.core.view_payments_menu and not perms.core.view_reports_menu %}
  <div class="content-header">
    <h1><i class="fas fa-tachometer-alt"></i> Dashboard</h1>
    <p class="text-muted">Welcome, {{ user.username }}. Quick actions for your work.</p>
  </div>

  <div class="row mt-3">
    <div class="col-md-6">
      <div class="card">
        <div class="card-body text-center">
          <h5 class="mb-3">Submit a Bill</h5>
          <p class="text-muted">Upload your bill with description and amount for manager review.</p>
          {% if perms.core.submit_bill %}
            <a href="{% url 'submit_bill_claim' %}" class="btn btn-primary">
              <i class="fas fa-file-upload"></i> Submit Bill
            </a>
          {% else %}
            <div class="alert alert-warning mb-0">You don't have permission to submit bills.</div>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <div class="card-body text-center">
          <h5 class="mb-3">My Bills</h5>
          <p class="text-muted">View the bills you've submitted and their status.</p>
          {% if perms.core.view_my_bills %}
            <a href="{% url 'my_bill_claims' %}" class="btn btn-outline-primary">
              <i class="fas fa-list-alt"></i> My Bills
            </a>
          {% else %}
            <div class="alert alert-warning mb-0">You don't have permission to view your bills.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% else %}
  {% comment %} End minimal dashboard {% endcomment %}

<div class="content-header">
  <h1><i class="fas fa-tachometer-alt"></i> Dashboard</h1>
  <p class="text-muted">Overview of your organization</p>
</div>

<!-- Statistics Cards -->
<div class="row">
  <div class="col-md-3">
    <div class="card stat-card h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <h6 class="text-muted">Active Employees</h6>
            <h2>{{ total_employees }}</h2>
          </div>
          <div class="align-self-center">
            <i class="fas fa-users fa-3x text-primary"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card stat-card success h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <h6 class="text-muted">Active Customers</h6>
            <h2>{{ total_customers }}</h2>
          </div>
          <div class="align-self-center">
            <i class="fas fa-user-tie fa-3x text-success"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card stat-card warning h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <h6 class="text-muted">Inventory Items</h6>
            <h2>{{ total_inventory_items }}</h2>
            {% if low_stock_items > 0 %}
            <small class="text-danger d-block">{{ low_stock_items }} low stock</small>
            {% endif %}
          </div>
          <div class="align-self-center">
            <i class="fas fa-boxes fa-3x text-warning"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card stat-card danger h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <h6 class="text-muted">Sales Balance Due</h6>
            <h2>${{ total_sales_due|floatformat:0 }}</h2>
            <small class="text-muted d-block"
              >{{ pending_sales }} draft sales</small
            >
          </div>
          <div class="align-self-center">
            <i class="fas fa-file-invoice-dollar fa-3x text-danger"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Second Row Stats -->
<div class="row mt-3">
  <div class="col-md-3">
    <div class="card h-100">
      <div class="card-body text-center">
        <h6 class="text-muted">Total Inventory Value</h6>
        <h3 class="text-success">${{ total_inventory_value|floatformat:2 }}</h3>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card h-100">
      <div class="card-body text-center">
        <h6 class="text-muted">Today's Sales (Finalized)</h6>
        <h3 class="text-success">${{ today_sales_total|floatformat:2 }}</h3>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card h-100">
      <div class="card-body text-center">
        <h6 class="text-muted">Monthly Expenses</h6>
        <h3 class="text-primary">${{ monthly_expenses|floatformat:2 }}</h3>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card h-100">
      <div class="card-body text-center">
        <h6 class="text-muted">Pending Bill Claims</h6>
        <h3 class="text-warning">{{ pending_bill_claims }}</h3>
      </div>
    </div>
  </div>
</div>

<!-- Recent Activity -->
<div class="row mt-4">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <i class="fas fa-shopping-cart"></i> Recent Sales
      </div>
      <div class="card-body">
        {% if recent_sales %}
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Sale #</th>
                <th>Customer</th>
                <th>Amount</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {% for sale in recent_sales %}
              <tr>
                <td><a href="{% url 'sale_detail' sale.pk %}">{{ sale.sale_number }}</a></td>
                <td>{{ sale.customer.name }}</td>
                <td>${{ sale.total_amount|floatformat:2 }}</td>
                <td>
                  {% if sale.status == 'finalized' %}
                  <span class="badge bg-success"
                    >{{ sale.get_status_display }}</span
                  >
                  {% elif sale.status == 'draft' %}
                  <span class="badge bg-warning"
                    >{{ sale.get_status_display }}</span
                  >
                  {% elif sale.status == 'quote' %}
                  <span class="badge bg-info"
                    >{{ sale.get_status_display }}</span
                  >
                  {% else %}
                  <span class="badge bg-secondary"
                    >{{ sale.get_status_display }}</span
                  >
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <a
          href="{% url 'sale_list' %}"
          class="btn btn-sm btn-outline-primary"
          >View All</a
        >
        {% else %}
        <p class="text-muted">No recent sales</p>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <i class="fas fa-receipt"></i> Recent Expenses
      </div>
      <div class="card-body">
        {% if recent_expenses %}
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Date</th>
                <th>Category</th>
                <th>Amount</th>
              </tr>
            </thead>
            <tbody>
              {% for expense in recent_expenses %}
              <tr>
                <td>{{ expense.date }}</td>
                <td>{{ expense.get_category_display }}</td>
                <td class="text-danger">${{ expense.amount }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <a
          href="{% url 'expense_list' %}"
          class="btn btn-sm btn-outline-primary"
          >View All</a
        >
        {% else %}
        <p class="text-muted">No recent expenses</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Low Stock Alerts -->
{% if low_stock_alerts %}
<div class="row mt-4">
  <div class="col-12">
    <div class="card border-warning">
      <div class="card-header bg-warning text-white">
        <i class="fas fa-exclamation-triangle"></i> Low Stock Alerts
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>Part Code</th>
                <th>Part Name</th>
                <th>Current Stock</th>
                <th>Minimum Stock</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {% for item in low_stock_alerts %}
              <tr>
                <td>{{ item.part_code }}</td>
                <td>{{ item.part_name }}</td>
                <td class="text-danger">
                  <strong>{{ item.quantity }}</strong>
                </td>
                <td>{{ item.minimum_stock }}</td>
                <td>
                  <a
                    href="{% url 'inventory_edit' item.pk %}"
                    class="btn btn-sm btn-warning"
                  >
                    <i class="fas fa-edit"></i> Update Stock
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <a href="{% url 'inventory_list' %}?low_stock=1" class="btn btn-warning"
          >View All Low Stock Items</a
        >
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Top Selling Products (All Time) -->
<div class="row mt-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <div>
          <i class="fas fa-chart-bar"></i> Top Selling Products
          <small class="text-muted d-block">All Time Â· By Quantity</small>
        </div>
        <span class="badge bg-light text-dark">Top 10</span>
      </div>
      <div class="card-body">
        {% if top_products %}
          <div class="list-group list-group-flush">
            {% for p in top_products %}
              <div class="list-group-item px-0">
                <div class="d-flex justify-content-between align-items-start gap-3">
                  <div class="d-flex align-items-start gap-3">
                    <div class="text-muted fw-semibold" style="min-width: 2.25rem;">#{{ forloop.counter }}</div>
                    <div>
                      <div class="fw-semibold">
                        {{ p.label|truncatechars:60 }}
                        {% if p.item_type == 'inventory' %}
                          <span class="badge bg-warning text-dark ms-2">Inventory</span>
                        {% else %}
                          <span class="badge bg-secondary ms-2">Machine</span>
                        {% endif %}
                      </div>
                      <div class="progress mt-2" style="height: 8px; max-width: 520px;">
                        {% if top_products_max_qty %}
                          {% widthratio p.total_qty top_products_max_qty 100 as bar_width %}
                          <div class="progress-bar bg-primary" role="progressbar"
                               style="width: {{ bar_width }}%"
                               aria-valuenow="{{ p.total_qty }}" aria-valuemin="0" aria-valuemax="{{ top_products_max_qty }}"></div>
                        {% else %}
                          <div class="progress-bar bg-primary" role="progressbar"
                               style="width: 0%"
                               aria-valuenow="{{ p.total_qty }}" aria-valuemin="0" aria-valuemax="{{ top_products_max_qty }}"></div>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                  <div class="text-end">
                    <div class="h5 mb-0">{{ p.total_qty }}</div>
                    <small class="text-muted">qty</small>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-muted mb-0">No finalized sales yet.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}